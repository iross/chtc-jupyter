#!/bin/bash
#
# chtc-jupyter - Simplified Jupyter Lab launcher for CHTC HTCondor
#
# Automates the workflow:
#   1. Submit jupyter.sub
#   2. Wait for job to start
#   3. Connect via condor_ssh_to_job with port forwarding
#   4. Launch Jupyter on the EP
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SUBMIT_FILE="${SUBMIT_FILE:-jupyter.sub}"
PORT="${PORT:-8889}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Submit the job
submit_job() {
    log_info "Submitting job from $SUBMIT_FILE..."

    local output
    output=$(condor_submit "$SUBMIT_FILE" 2>&1)
    local status=$?

    if [[ $status -ne 0 ]]; then
        log_error "Submit failed:"
        echo "$output"
        exit 1
    fi

    local job_id=$(echo "$output" | grep -oP 'submitted to cluster \K\d+' | head -1)

    if [[ -z "$job_id" ]]; then
        log_error "Could not parse job ID"
        exit 1
    fi

    log_success "Submitted as job $job_id"
    echo "$job_id"
}

# Wait for job to start running
wait_for_job() {
    local job_id=$1

    log_info "Waiting for job $job_id to start..."

    while true; do
        local status=$(condor_q "$job_id" -af JobStatus 2>/dev/null || echo "")

        if [[ -z "$status" ]]; then
            log_error "Job $job_id not found"
            exit 1
        fi

        case $status in
            2) # Running
                log_success "Job is running"
                return 0
                ;;
            3|4) # Removed/Completed
                log_error "Job ended before starting"
                exit 1
                ;;
            5) # Held
                log_error "Job is held. Check: condor_q -hold $job_id"
                exit 1
                ;;
            1) # Idle
                echo -n "."
                sleep 5
                ;;
        esac
    done
}

# Connect and launch
connect_and_launch() {
    local job_id=$1
    local port=$2

    log_info "Connecting to job $job_id with port $port..."
    log_info ""
    log_info "Jupyter will start automatically."
    log_info "Look for the URL with token and paste it in your browser."
    log_info ""

    # Create temporary SSH script with port forwarding
    local temp_ssh=$(mktemp)
    cat > "$temp_ssh" << EOF
#!/bin/bash
exec ssh -L ${port}:localhost:${port} "\$@"
EOF
    chmod +x "$temp_ssh"

    # Connect and run launch script
    condor_ssh_to_job -ssh "$temp_ssh" "$job_id" << EOFREMOTE
# Source conda if needed
[[ -f /opt/conda/bin/activate ]] && source /opt/conda/bin/activate

# Launch Jupyter
if [[ -f ./launch_jupyter.sh ]]; then
    ./launch_jupyter.sh $port
else
    export HOME=\$(pwd)
    jupyter lab --no-browser --port=$port
fi
EOFREMOTE

    rm -f "$temp_ssh"
}

# Main
main() {
    if [[ ! -f "$SUBMIT_FILE" ]]; then
        log_error "Submit file not found: $SUBMIT_FILE"
        log_info "Usage: PORT=8889 SUBMIT_FILE=jupyter.sub $0"
        exit 1
    fi

    local job_id
    job_id=$(submit_job)

    wait_for_job "$job_id"

    echo ""
    connect_and_launch "$job_id" "$PORT"
}

main "$@"
